<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>bo</title>
  <style type="text/css">
    #msg {
      width: 98%; height: 200px; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; color: #555
    }
    #mesend { font-family: sans-serif; color: #666; height: 300px; overflow-y: auto }
  </style>
</head>
<body style="line-height: 1.44; color: #444; margin: 0">
<div style="float: left; width: 88%">
  <img id="ss" src="" style="max-width: 99.5%">
</div>
<div style="float: right; width: 11.8%">
  <div id="mesend"></div>
  <div>
    <label for="lc">left</label><input type="radio" id="lc" name="mousebutton" value="leftclick" checked>&nbsp;
    <label for="rc">right</label><input type="radio" id="rc" name="mousebutton" value="rightclick">&nbsp;
    <label for="dc">double</label><input type="radio" id="dc" name="mousebutton" value="doubleclick">&nbsp;
  </div>
  <textarea id="msg"></textarea>
  <br>
  <button onclick="send()">&gt;</button>
  <br><br>
  <label for="sleepPeriod">Sleep period:</label>
  <input type="text" id="sleepPeriod" size="7">
  <span class="space"></span>
  <button onclick="setSleepPeriod()">Set</button>
  <span class="space"></span>
  <button onclick="getSleepPeriod()">Get</button>
</div>
<script type="text/javascript">
  let sleepPeriod = 8419;

  async function runPeriodically() {
    const response = await fetch('/need-reload', {
      method: 'GET',
      cache: 'no-cache'
    });
    if (response.ok && response.status === 201) reloadScreenshot();
    const json = await response.json();
    if (json['message']) {
      const p = document.createElement('p');
      p.innerHTML = json['message'];
      document.getElementById('mesend').appendChild(p)
    }
    setTimeout(runPeriodically, sleepPeriod)
  }

  function getSleepPeriod() {
    document.getElementById('sleepPeriod').value = sleepPeriod;
  }

  function setSleepPeriod() {
    sleepPeriod = parseInt(document.getElementById('sleepPeriod').value);
    getSleepPeriod();
  }

  function reloadScreenshot() {
    document.getElementById('ss').setAttribute('src', '/latest-screen?__=' + new Date().getTime())
  }

  function send() {
    fetch('/bo-send', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
      },
      body: document.getElementById('msg').value
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error));
  }

  setTimeout(runPeriodically, sleepPeriod);

  document.getElementById('ss').onclick = function(e) {
    const img = document.getElementById('ss');
    const action = Array.from(document.querySelectorAll('input[type="radio"][name="mousebutton"]'))
        .find(radio => radio.checked)
        .value;
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: action,
        x: Math.round(e.pageX / img.clientWidth * 1920),
        y: Math.round(e.pageY / img.clientHeight * 1080)
      })
    })
  };
</script>
</body>
</html>