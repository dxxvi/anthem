<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>bo</title>
  <style type="text/css">
    #msg {
      width: 98%; height: 200px; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; color: #555
    }
    #mesend { font-family: sans-serif; color: #666; height: 300px; overflow-y: auto }
  </style>
</head>
<body style="line-height: 1.44; color: #444; margin: 0">
<div style="float: left; width: 88%">
  <img id="ss" src="" style="max-width: 99.5%">
</div>
<div style="float: right; width: 11.8%">
  <div id="mesend"></div>
  <textarea id="msg"></textarea>
  <br>
  <button onclick="send()">&gt;</button>
  <br><br>
  <label for="sleepPeriod">Sleep period:</label>
  <input type="text" id="sleepPeriod" size="7">
  <span class="space"></span>
  <button onclick="setSleepPeriod()">Set</button>
  <span class="space"></span>
  <button onclick="getSleepPeriod()">Get</button>
</div>
<script type="text/javascript">
  let sleepPeriod = 8419;

  function runPeriodically() {
    fetch('/need-reload', {
      method: 'GET',
      cache: 'no-cache'
    })
        .then(response => {
          if (response.ok && response.status === 201) reloadScreenshot();
          setTimeout(runPeriodically, sleepPeriod)
        })
        .catch(error => console.error(error));

    fetch('/me-message', {
      method: 'GET',
      cache: 'no-cache'
    })
        .then(response => response.json())
        .then(json => {
          if (json['message']) {
            const p = document.createElement('p');
            p.innerHTML = json['message'];
            document.getElementById('mesend').appendChild(p)
          }
        })
        .catch(error => console.error(error));
  }

  function getSleepPeriod() {
    document.getElementById('sleepPeriod').value = sleepPeriod;
  }

  function setSleepPeriod() {
    sleepPeriod = parseInt(document.getElementById('sleepPeriod').value);
    getSleepPeriod();
  }

  function reloadScreenshot() {
    document.getElementById('ss').setAttribute('src', '/latest-screen?__=' + new Date().getTime())
  }

  function send() {
    fetch('/bo-send', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
      },
      body: document.getElementById('msg').value
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error));
  }

  setTimeout(runPeriodically, sleepPeriod);
</script>
</body>
</html>