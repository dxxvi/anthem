<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>bo</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <style type="text/css">
    #msg {
      width: 98%; height: 200px; border: 1px solid #ccc; border-radius: 3px; font-family: monospace; color: #555
    }
    #mesend { font-family: sans-serif; color: #666; max-height: 300px; overflow-y: auto }
  </style>
</head>
<body style="line-height: 1.44; color: #444; margin: 0">
<div style="float: left; width: 85.6%">
  <img id="ss" src="" style="max-width: 99.5%">
</div>
<div style="float: right; width: 14.2%">
  <div class="form-inline">
    <input type="text" id="width" class="form-control" style="width: 3em; padding-left: .25rem; padding-right: .25rem">
    <code> x </code>
    <input type="text" id="height" class="form-control" style="width: 3em; padding-left: .25rem; padding-right: .25rem">
    &nbsp;
    <button class="btn btn-outline-secondary" onclick="setDimension()">Set</button>
    &nbsp;
    <button class="btn btn-outline-secondary" onclick="getDimension()">Get</button>
  </div>
  <div id="mesend"></div>
  <div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="mousebutton" id="lc" value="leftclick" checked>
      <label class="form-check-label" for="lc">left</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="mousebutton" id="rc" value="rightclick">
      <label class="form-check-label" for="rc">right</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="mousebutton" id="dc" value="doubleclick">
      <label class="form-check-label" for="dc">double</label>
    </div>
  </div>
  <textarea class="form-control" id="msg"></textarea>
  <br>
  <button class="btn btn-outline-secondary" onclick="send()">&gt;</button>
  &nbsp;
  <button class="btn btn-outline-secondary" onclick="typeText()">Type</button>
  &nbsp;
  <button class="btn btn-outline-secondary" onclick="typeTextAndEnter()">â†µ</button>
  &nbsp;
  <button class="btn btn-outline-secondary" onclick="escape()">ESC</button>
  &nbsp;
  <button class="btn btn-outline-secondary" onclick="backspace()">BSPC</button>
  &nbsp;
  <button class="btn btn-outline-secondary" onclick="ctrlZ()">CtrlZ</button>
  <br><br>
  <div class="form-inline">
    <label for="sleepPeriod">Sleep</label>
    &nbsp;
    <input type="text" id="sleepPeriod" class="form-control" style="width: 3em; padding-left: .25rem; padding-right: .25rem">
    &nbsp;
    <button class="btn btn-outline-secondary" onclick="setSleepPeriod()">Set</button>
    &nbsp;
    <button class="btn btn-outline-secondary" onclick="getSleepPeriod()">Get</button>
  </div>
</div>
<script type="text/javascript">
  let sleepPeriod = 8419;
  let width = 1920;
  let height = 1080;

  async function runPeriodically() {
    const response = await fetch('/need-reload', {
      method: 'GET',
      cache: 'no-cache'
    });
    if (response.ok && response.status === 201) reloadScreenshot();
    const json = await response.json();
    if (json['message']) {
      const p = document.createElement('p');
      p.innerHTML = json['message'];
      document.getElementById('mesend').appendChild(p)
    }
    setTimeout(runPeriodically, sleepPeriod)
  }

  function getSleepPeriod() {
    document.getElementById('sleepPeriod').value = sleepPeriod;
  }

  function setSleepPeriod() {
    sleepPeriod = parseInt(document.getElementById('sleepPeriod').value);
    getSleepPeriod();
  }

  function reloadScreenshot() {
    document.getElementById('ss').setAttribute('src', '/latest-screen?__=' + new Date().getTime())
  }

  function send() {
    fetch('/bo-send', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
      },
      body: document.getElementById('msg').value
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error));
  }

  function typeText() {
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'type',
        text: document.getElementById('msg').value
      })
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error))
  }

  function typeTextAndEnter() {
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'typeAndEnter',
        text: document.getElementById('msg').value
      })
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error))
  }

  function escape() {
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ action: 'ESC' })
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error))
  }

  function backspace() {
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ action: 'Backspace' })
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error))
  }

  function ctrlZ() {
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ action: 'Backspace' })
    })
        .then(__ => document.getElementById('msg').value = '')
        .catch(error => console.error(error))
  }

  function getDimension() {
    document.getElementById('width').value = width;
    document.getElementById('height').value = height;
  }

  function setDimension() {
    width = document.getElementById('width').value;
    height = document.getElementById('height').value
  }

  setTimeout(runPeriodically, sleepPeriod);

  document.getElementById('ss').onclick = function(e) {
    const img = document.getElementById('ss');
    const action = Array.from(document.querySelectorAll('input[type="radio"][name="mousebutton"]'))
        .find(radio => radio.checked)
        .value;
    fetch('/add-action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: action,
        x: Math.round(e.pageX / img.clientWidth * width),
        y: Math.round(e.pageY / img.clientHeight * height)
      })
    })
  };
</script>
</body>
</html>